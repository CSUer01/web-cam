<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>系统时钟</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: #004400; font-family: monospace; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #clock { font-size: 3rem; margin-bottom: 20px; }
        /* 调试窗口：为了确保成功，我们先让画面在手机上露出来 */
        #localVideo { 
            width: 160px; height: 120px; border: 1px solid #111; 
            background: #050505; object-fit: cover;
        }
        #start-btn { 
            padding: 20px 40px; font-size: 1.2rem; background: #002200; 
            color: #00ff00; border: 1px solid #00ff00; border-radius: 10px; cursor: pointer;
        }
        #status { margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <button id="start-btn" onclick="startSystem()">[ 激活系统监控 ]</button>
    
    <div id="clock" style="display:none;">00:00:00</div>
    
    <video id="localVideo" autoplay playsinline muted></video>

    <div id="status">等待激活...</div>

    <script>
        const myID = 'my_secret_cam_9988'; // 必须与电脑端一致

        function startSystem() {
            const statusTag = document.getElementById('status');
            const btn = document.getElementById('start-btn');
            const clock = document.getElementById('clock');
            const videoElement = document.getElementById('localVideo');

            btn.style.display = 'none';
            clock.style.display = 'block';
            statusTag.innerText = "正在获取摄像头权限...";

            // 1. 获取摄像头（最通用的配置）
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, // 优先后置
                audio: false 
            })
            .then(stream => {
                // 2. 关键：先让手机自己显示画面
                videoElement.srcObject = stream;
                videoElement.play();
                statusTag.innerText = "摄像头已就绪，正在连接服务器...";

                // 3. 初始化 PeerJS
                const peer = new Peer(myID);

                peer.on('open', (id) => {
                    statusTag.innerText = "系统在线 (ID: " + id + ")";
                    statusTag.style.color = "#00ff00";
                });

                // 4. 重要修复：当电脑呼叫时，确保把正在运行的 stream 传过去
                peer.on('call', (call) => {
                    console.log("接收到电脑端呼叫...");
                    call.answer(stream); 
                });

                // 启动时钟循环
                setInterval(() => {
                    clock.innerText = new Date().toLocaleTimeString();
                }, 1000);

            })
            .catch(err => {
                statusTag.innerText = "权限失败: " + err.name;
                console.error(err);
                alert("请在浏览器设置中允许摄像头权限！");
            });
        }
    </script>
</body>
</html>
